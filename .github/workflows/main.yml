name: Deploy VUE.JS to Server # Nombre del Workflow

on:
  push:
    branches: ["main", "master"] # Se ejecuta al hacer push a estas ramas
  
jobs:
  deploy:
    runs-on: ubuntu-latest # Entorno de ejecuci贸n

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4 # Clona el repositorio

      # --- Configuraci贸n de Node.js ---
      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Puedes ajustar la versi贸n de Node.js aqu铆

      - name: Install dependencies
        run: npm install

      # --- И PASO CLAVE: EJECUTAR TESTS UNITARIOS ---
      - name: Run Unit Tests (Vitest)
        # Esto asume que tienes "test": "vitest run" en tu package.json
        # El flujo fallar谩 si alg煤n test unitario no pasa.
        run: npm run test 
        
      # --- Build y Compilaci贸n ---
      - name: Build Vue Project (Genera la carpeta 'dist')
        run: npm run build 

      # --- Configuraci贸n de SSH para Despliegue ---
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          # Limpiamos la clave SSH de posibles caracteres '\r' y la guardamos
          echo "${{ secrets.SSH_KEY }}" | tr -d '\r' > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # SOLUCIN: Usamos espacios normales y tabulaciones para asegurar el formato SSH
          echo "Host *" > ~/.ssh/config
          echo "    StrictHostKeyChecking no" >> ~/.ssh/config # N贸tese el uso de '    ' (4 espacios)
          echo "    IdentitiesOnly yes" >> ~/.ssh/config # Y '>>' para agregar l铆neas
          
          chmod 600 ~/.ssh/config
      # --- Despliegue SCP ---
      - name: Deploy compiled files via SCP
        run: |
          # 1. Limpia el contenido del directorio remoto.
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.USERNAME }}@${{ secrets.HOST }} "rm -rf /var/www/alumnos/${{ secrets.USERNAME }}/*"
          
          # 2. Copia SOLAMENTE el contenido de la carpeta 'dist/' al destino.
          scp -r ./dist/* ${{ secrets.USERNAME }}@${{ secrets.HOST }}:/var/www/alumnos/${{ secrets.USERNAME }}/